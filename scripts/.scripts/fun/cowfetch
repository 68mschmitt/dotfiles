#!/bin/bash
#
# cowfetch - fastfetch with colorful cowsay ASCII art (via lolcat)
#

COW_FILE="${COW_FILE:-default}"
COW_MESSAGE="${COW_MESSAGE:-$(hostname -s)}"
FASTFETCH_CONFIG="${FASTFETCH_CONFIG:-examples/13.jsonc}"
LOLCAT_OPTS="${LOLCAT_OPTS:--f}"
NO_COLOR="${NO_COLOR:-}"

show_help() {
    cat << 'EOF'
cowfetch - fastfetch with colorful cowsay ASCII art

Usage: cowfetch [figure] [message]
       cowfetch [options]

Options:
  -h, --help      Show this help message
  -l, --list      List available cow figures
  -n, --no-color  Disable rainbow colors (plain cowsay)
  -r, --random    Randomly select a cow figure

Environment Variables:
  COW_FILE          Cowsay figure (default: default)
  COW_MESSAGE       Message for the cow (default: hostname)
  FASTFETCH_CONFIG  Fastfetch config preset (default: examples/13.jsonc)
  LOLCAT_OPTS       Options for lolcat (default: -f)
  NO_COLOR          Set to disable rainbow colors

Examples:
  cowfetch                                      # Rainbow cow with hostname
  cowfetch tux "I use Arch btw"                 # Rainbow tux
  cowfetch dragon "RAWR!"                       # Rainbow dragon
  cowfetch -n tux "Plain tux"                   # No rainbow
  LOLCAT_OPTS="-f -S 50" cowfetch               # Custom lolcat seed
  
Available cow figures:
EOF
    cowsay -l | tail -n +2
}

RANDOM_COW=""

while [[ "$1" == -* ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        -l|--list)
            cowsay -l
            exit 0
            ;;
        -n|--no-color)
            NO_COLOR=1
            shift
            ;;
        -r|--random)
            RANDOM_COW=1
            shift
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

if [[ -n "$RANDOM_COW" ]]; then
    COW_FILE=$(cowsay -l | tail -n +2 | tr ' ' '\n' | grep -v '^$' | shuf -n 1)
    # With --random, $1 is the message (if any)
    if [[ -n "$1" ]]; then
        COW_MESSAGE="$1"
    fi
else
    if [[ -n "$1" ]]; then
        COW_FILE="$1"
    fi
    if [[ -n "$2" ]]; then
        COW_MESSAGE="$2"
    fi
fi

MODULE_LINES="${MODULE_LINES:-16}"

# Generate cowsay output (without color first to count lines)
COW_PLAIN=$(cowsay -f "$COW_FILE" "$COW_MESSAGE")
COW_LINES=$(echo "$COW_PLAIN" | wc -l | tr -d ' ')

# Calculate padding to vertically center cow and modules
LOGO_PADDING=0
if [[ $MODULE_LINES -gt $COW_LINES ]]; then
    # Modules taller than cow: pad the cow (prepend newlines to center it)
    PADDING=$(( (MODULE_LINES - COW_LINES) / 2 ))
    PADDING_STR=""
    for ((i=0; i<PADDING; i++)); do
        PADDING_STR+=$'\n'
    done
    COW_PLAIN="${PADDING_STR}${COW_PLAIN}"
elif [[ $COW_LINES -gt $MODULE_LINES ]]; then
    # Cow taller than modules: pad the logo top (pushes cow down, centering modules)
    LOGO_PADDING=$(( (COW_LINES - MODULE_LINES) / 2 ))
fi

# Apply color if enabled
if [[ -n "$NO_COLOR" ]] || ! command -v lolcat &> /dev/null; then
    LOGO="$COW_PLAIN"
else
    LOGO=$(echo "$COW_PLAIN" | lolcat $LOLCAT_OPTS)
fi

fastfetch --data-raw "$LOGO" -c "$FASTFETCH_CONFIG" --logo-padding-top "$LOGO_PADDING"
